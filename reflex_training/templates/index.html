<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflex Training App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="content">
    <!-- Menu điều hướng -->
    <nav style="margin-bottom:20px;">
        <a href="/" style="margin-right:20px;">Trang chính</a>
        <a href="/sentence_practice" style="margin-right:20px;">Luyện mẫu câu</a>
        <a href="/repeat_sentence" style="margin-right:20px;">Repeat Sentence</a>
        <label style="margin-left:10px;">
    Giọng đọc
    <select id="voiceSelect" style="min-width:120px;"></select>
</label>
    </nav>
    <h1>Sentence Practice</h1>
    <div id="status" style="font-size:2em; color:blue; font-weight:bold; margin-bottom:20px;"></div>
    <div class="flex-main">
        <!-- Bên trái: Thực hành -->
        <div style="flex: 6; min-width: 0;">
            <div>
                <label for="intervalInput"><b>Thời gian mỗi lượt (giây):</b></label>
                <input type="number" id="intervalInput" value="10" min="1" max="60" style="width:60px;">
                <button onclick="updateInterval()">Cập nhật</button>
                <button onclick="togglePause()">Pause</button>
                <label style="margin-left:15px;">
                    <input type="checkbox" id="autoSpeakCheckbox" checked>
                    Phát âm từ
                </label>
                <label style="margin-left:10px;">
                    Lặp lại mỗi
                    <input type="number" id="repeatSpeakInterval" value="2" min="1" max="10" style="width:40px;">
                    giây
                </label>
                <label style="margin-left:10px;">
                    Số lần xuất hiện/từ/ngày
                    <input type="number" id="maxShowPerDay" value="3" min="1" max="20" style="width:40px;">
                </label>
                <span id="intervalStatus" style="margin-left:10px;color:green;font-weight:bold;"></span>
            </div>
            <div id="timer" style="font-size:2em; color:green; font-weight:bold; margin-bottom:20px;"></div>
            <div id="output"></div>
            <h2>1. Random Number Generator</h2>
            <label>Min: <input type="number" id="minNumber" value="-1000" style="width:80px;"></label>
            <label>Max: <input type="number" id="maxNumber" value="1000000000" style="width:110px;"></label>
            <button onclick="startPractice('number')">Practice Number</button>
            <h2>2. Random Year Generator (Up to 2999)</h2>
            <label>Min: <input type="number" id="minYear" value="1" style="width:80px;"></label>
            <label>Max: <input type="number" id="maxYear" value="2999" style="width:110px;"></label>
            <button onclick="startPractice('year')">Practice Year</button>
            <h2>3. Linked Speech Practice</h2>
            <input type="text" id="wordInput" placeholder="Enter words (e.g., about it, going to)">
            <input type="text" id="guideInput" placeholder="Pronunciation guide (optional)">
            <button onclick="addWords()">Add Words</button>
            <button onclick="startPractice('word')">Practice Word</button>
            <!-- Thêm vào sau phần nhập câu -->
            <div style="margin-top:20px;">
                   <form id="excelForm" enctype="multipart/form-data" style="margin-top:15px;">
                    <label><b>Nhập câu từ file Excel:</b></label>
                    <input type="file" id="excelFile" name="excelFile" accept=".xlsx,.xls">
                    <button type="submit">Tải lên</button>
                </form>
                <div id="excelStatus" style="color:green;margin-top:5px;"></div>
            </div>
        </div>
        
        <!-- Bên phải: Danh sách từ và tìm kiếm -->
        <div style="flex: 2; min-width: 0; background: #fff; padding: 15px; border: 1px solid #ccc;">
            <div>
                <input type="text" id="searchInput" placeholder="Tìm kiếm từ..." style="width:70%;">
                <button onclick="searchWordList()">Tìm</button>
            </div>
            <div id="wordList" style="margin-top:15px;"></div>
        </div>
    </div>
</div>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
function showWordList() {
    $.get('/words', function(words) {
        if (!words.length) {
            document.getElementById('wordList').innerHTML = '<i>Chưa có từ nào.</i>';
            return;
        }
        let html = '<b>Danh sách từ:</b><ul style="margin-top:5px;">';
        words.forEach(wordObj => {
            html += `<li>
                <span style="cursor:pointer;color:#007bff;text-decoration:underline;" onclick="showWordDetail('${wordObj.word.replace(/'/g,"\\'")}')">${wordObj.word}</span>
                <button onclick="deleteWord('${wordObj.word}')" style="font-size:0.9em;padding:2px 8px;margin-left:8px;">Xoá</button>
                <button onclick="togglePriority('${wordObj.word}')" style="font-size:0.9em;padding:2px 8px;margin-left:8px;${wordObj.priority ? 'background:orange;' : ''}">${wordObj.priority ? 'Bỏ ưu tiên' : 'Ưu tiên'}</button>
            </li>`;
        });
        html += '</ul>';
        document.getElementById('wordList').innerHTML = html;
    });
}

function showWordDetail(word) {
    $.get(`/guides`, function(guides) {
        let guide = guides[word] || "No guide available.";
        document.getElementById('output').innerHTML = `
            <div style="font-size:1.3em;"><b>Practice this:</b> ${word}<br>
            <b>Pronunciation Guide:</b> ${guide}</div>
            <div style="margin-top:10px; display:flex; align-items:center; justify-content: flex-end;">
                <button 
                    onclick="speak('${word.replace(/'/g,"\\'")}')" 
                    style="font-size:1.1em; padding:10px 20px; float:right; margin-top:0; margin-bottom:0; margin-right:0; margin-left:20px; height:100%;">Read</button>
            </div>
        `;
        currentText = word;
    });
}

function togglePriority(word) {
    fetch(`/words/priority/${encodeURIComponent(word)}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.words) showWordList();
            else alert(data.error || 'Update failed');
        });
}

let voices = [];
function loadVoices() {
    voices = window.speechSynthesis.getVoices().filter(v => v.lang && v.lang.toLowerCase().startsWith('en'));
    const voiceSelect = document.getElementById('voiceSelect');
    if (!voiceSelect) return;
    voiceSelect.innerHTML = '';
    voices.forEach((voice, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.text = `${voice.name} (${voice.lang})${voice.default ? ' [default]' : ''}`;
        voiceSelect.appendChild(option);
    });
}
window.speechSynthesis.onvoiceschanged = loadVoices;
window.addEventListener('DOMContentLoaded', loadVoices);

function speak(text) {
    if (text) {
        const utterance = new SpeechSynthesisUtterance(text);
        const voiceSelect = document.getElementById('voiceSelect');
        if (voiceSelect && voices[voiceSelect.value]) {
            utterance.voice = voices[voiceSelect.value];
            utterance.lang = voices[voiceSelect.value].lang;
        }
        window.speechSynthesis.speak(utterance);
    }
}

$('#excelForm').on('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('excelFile');
    if (!fileInput.files.length) {
        $('#excelStatus').css('color','red').text('Chưa chọn file!');
        return;
    }
    const formData = new FormData();
    formData.append('excelFile', fileInput.files[0]);
    // Chọn target phù hợp với từng trang
    formData.append('target', 'words'); // hoặc 'repeat_sentences' hoặc 'words'
    $.ajax({
        url: '/upload_sentences',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(res) {
            $('#excelStatus').css('color','green').text(res.message);
            loadSentences && loadSentences();
        },
        error: function(xhr) {
            $('#excelStatus').css('color','red').text(xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Lỗi!');
        }
    });
});
</script>
</body>
</html>