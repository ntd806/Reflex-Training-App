<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .nav { margin-bottom: 20px; }
        .nav a { margin-right: 10px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .done { background-color: #d4edda; }
        .current-practice { font-weight: bold; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/">Trang chính</a>
        <a href="/sentence_practice">Write from dictation</a>
        <a href="/repeat_sentence">Repeat Sentence</a>
        <a href="/ending_practice">Practice -S/-ES & -ED</a>
        <a href="/irregular_verbs">Irregular Verbs</a>
        <a href="/youtube_tracker">YouTube Tracker</a>
        <a href="/speaking_describe_image_page">Speaking Describe Image</a>
        <a href="/random_currency">Random Currency</a>
        <a href="/schedule_ui">schedual</a>
        <a href="/essay_vocab">essay vocab</a>
        <select id="voiceSelect">
            <option value="en-US">English (US)</option>
            <option value="en-GB">English (UK)</option>
        </select>
    </div>

    <h2>Giải thích các hoạt động</h2>
    <div id="activityDefinitions"></div>

    <h2>Lịch biểu hôm nay</h2>
    <table id="todaySchedule">
        <thead>
            <tr>
                <th>Thời gian</th>
                <th>Hoạt động</th>
                <th>Trạng thái</th>
                <th>Bài hiện tại</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Lịch biểu tuần</h2>
    <div id="weeklySchedule"></div>

    <h2>Thống kê tiến độ</h2>
    <div id="progressStats"></div>

    <script>
        $(document).ready(function() {
            $.getJSON('/schedule', function(data) {
                const schedule = data.schedule;
                const status = data.status;
                const currentPractice = data.current_practice;
                const today = data.today;
                const weekDay = data.week_day;

                // Hiển thị định nghĩa hoạt động
                let definitions = '<ul>';
                for (let key in schedule.activity_definitions) {
                    definitions += `<li><strong>${key}</strong>: ${schedule.activity_definitions[key]}</li>`;
                }
                definitions += '</ul>';
                $('#activityDefinitions').html(definitions);

                // Hiển thị lịch hôm nay
                let todayHtml = '';
                if (schedule.weekly_plan[weekDay]) {
                    schedule.weekly_plan[weekDay].forEach((item, idx) => {
                        const isDone = status[today] && status[today][weekDay] && status[today][weekDay].includes(idx);
                        const practiceItem = currentPractice[today] && currentPractice[today][weekDay] && currentPractice[today][weekDay][idx] ? currentPractice[today][weekDay][idx] : '';
                        todayHtml += `
                            <tr class="${isDone ? 'done' : ''}">
                                <td>${item.duration}</td>
                                <td>${item.activity} (${schedule.activity_definitions[item.activity] || item.activity})</td>
                                <td>
                                    <button onclick="markDone('${weekDay}', ${idx}, '${today}')">${isDone ? 'Đã hoàn thành' : 'Đánh dấu hoàn thành'}</button>
                                </td>
                                <td>
                                    <input type="text" id="practice_${weekDay}_${idx}" value="${practiceItem}" placeholder="Nhập bài hiện tại">
                                    <button onclick="savePracticeItem('${weekDay}', ${idx}, '${today}')">Lưu</button>
                                </td>
                            </tr>`;
                    });
                }
                $('#todaySchedule tbody').html(todayHtml);

                // Hiển thị lịch tuần
                let weeklyHtml = '';
                for (let day in schedule.weekly_plan) {
                    weeklyHtml += `<h3>${day}</h3><table><thead><tr><th>Thời gian</th><th>Hoạt động</th></tr></thead><tbody>`;
                    schedule.weekly_plan[day].forEach(item => {
                        weeklyHtml += `<tr><td>${item.duration}</td><td>${item.activity} (${schedule.activity_definitions[item.activity] || item.activity})</td></tr>`;
                    });
                    weeklyHtml += '</tbody></table>';
                }
                $('#weeklySchedule').html(weeklyHtml);

                // Thống kê tiến độ
                let progressHtml = '<ul>';
                for (let date in status) {
                    for (let day in status[date]) {
                        progressHtml += `<li>${date} (${day}): Đã hoàn thành ${status[date][day].length} / ${schedule.weekly_plan[day].length} hoạt động</li>`;
                    }
                }
                progressHtml += '</ul>';
                $('#progressStats').html(progressHtml);
            });

            $('#voiceSelect').change(function() {
                // Xử lý thay đổi giọng đọc nếu cần
            });
        });

        function markDone(day, idx, date) {
            $.ajax({
                url: '/schedule/mark_done',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ day, idx, date }),
                success: function() {
                    location.reload();
                }
            });
        }

        function savePracticeItem(day, idx, date) {
            const practiceItem = $(`#practice_${day}_${idx}`).val();
            $.ajax({
                url: '/current_practice',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ date, day, idx, practice_item: practiceItem }),
                success: function(response) {
                    alert('Đã lưu bài thực hành hiện tại!');
                    location.reload();
                },
                error: function() {
                    alert('Lỗi khi lưu bài thực hành.');
                }
            });
        }
    </script>
</body>
</html>