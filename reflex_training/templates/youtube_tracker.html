<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YouTube Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .flex-main { display: flex; gap: 20px; }
        .yt-list-col { flex: 2; min-width: 0; background: #fff; padding: 15px; border: 1px solid #ccc; }
        .yt-player-col { flex: 6; min-width: 0; }
    </style>
</head>
<body>
<div class="content">
    <nav style="margin-bottom:20px; display: flex; align-items: center;">
        <a href="/" style="margin-right:20px;">Trang chính</a>
        <a href="/sentence_practice" style="margin-right:20px;">Luyện mẫu câu</a>
        <a href="/repeat_sentence" style="margin-right:20px;">Repeat Sentence</a>
        <a href="/youtube_tracker" style="margin-right:20px;">YouTube Tracker</a>
        <label style="margin-left:10px; display: flex; align-items: center;">
            <span style="margin-right:4px;">Giọng đọc</span>
            <select id="voiceSelect" style="min-width:100px; max-width:150px; height:28px; font-size:0.95em;"></select>
        </label>
        <input type="text" id="vocabInput" placeholder="Nhập từ vựng..." style="margin-left:30px; padding-left:28px; height:28px; border-radius:4px; border:1px solid #ccc; background:url('https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/book.svg') no-repeat 6px center/16px 16px, #fff;">
        <button onclick="readVocab()" style="margin-left:8px; height:32px; display:flex; align-items:center;">
            <span style="margin-right:4px;">Read</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" style="vertical-align:middle;" viewBox="0 0 16 16">
                <path d="M8 3a5 5 0 1 0 0 10A5 5 0 0 0 8 3zm0 1a4 4 0 1 1 0 8A4 4 0 0 1 8 4zm.5 2.5a.5.5 0 0 0-1 0v2.793l1.146 1.147a.5.5 0 0 0 .708-.708L8.5 8.293V6.5z"/>
            </svg>
        </button>
    </nav>
    <h1>YouTube Tracker</h1>
    <div class="flex-main">
        <!-- Bên trái: player và nhập link -->
        <div class="yt-player-col">
            <div>
                <input type="text" id="youtubeInput" placeholder="Paste YouTube link..." style="width:60%;">
                <button onclick="addYoutubeLink()">Add</button>
                <span id="loadingStatus" style="margin-left:10px; color:green; font-weight:bold;"></span>
            </div>
            <div id="playerSection" style="margin-top:30px; width:100%;"></div>
        </div>
        <!-- Bên phải: danh sách video -->
        <div class="yt-list-col">
            <div>
                <input type="text" id="searchInput" placeholder="Tìm kiếm video..." style="width:70%;">
                <button onclick="searchYoutubeList()">Tìm</button>
            </div>
            <div id="youtubeList" style="margin-top:20px;"></div>
        </div>
    </div>
</div>
<script>
let allYoutubeLinks = [];
let ytPlayer, ytPlayerInterval, lastUrl = '', lastVideoId = '', lastTime = 0;

// Load YouTube IFrame API
(function() {
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
})();

window.onYouTubeIframeAPIReady = function() {
    // Không tạo player ở đây, chỉ tạo khi playYoutube được gọi
};

function addYoutubeLink() {
    const url = $('#youtubeInput').val().trim();
    if (!url) return;
    $('#loadingStatus').text('Đang thêm, vui lòng chờ...');
    $.ajax({
        url: '/youtube_links',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({url}),
        success: function() {
            $('#youtubeInput').val('');
            $('#loadingStatus').text('Thêm thành công!');
            loadYoutubeLinks();
            setTimeout(() => { $('#loadingStatus').text(''); }, 1500);
        },
        error: function(xhr) {
            let msg = 'Có lỗi, thử lại!';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                msg = xhr.responseJSON.error;
            }
            $('#loadingStatus').text(msg);
            setTimeout(() => { $('#loadingStatus').text(''); }, 2500);
        }
    });
}
function loadYoutubeLinks() {
    $.get('/youtube_links', function(links) {
        // Sắp xếp theo thời gian mới nhất
        links.sort((a, b) => (b.added_date || '').localeCompare(a.added_date || ''));
        allYoutubeLinks = links;
        renderYoutubeList(links);
    });
}
function renderYoutubeList(links) {
    let html = '<b>Danh sách video:</b><ul>';
    links.forEach(link => {
        html += `<li>
            <span style="cursor:pointer;color:blue;text-decoration:underline;" onclick="playYoutube('${link.url}',${link.last_time||0})">${link.title || link.url}</span>
            <span style="margin-left:10px;">[${link.watched ? 'Đã xem' : 'Chưa xem'}]</span>
            <span style="margin-left:10px;">${link.added_date}</span>
        </li>`;
    });
    html += '</ul>';
    $('#youtubeList').html(html);
}
function searchYoutubeList() {
    const q = $('#searchInput').val().trim().toLowerCase();
    if (!q) {
        renderYoutubeList(allYoutubeLinks);
        return;
    }
    const filtered = allYoutubeLinks.filter(link => link.url.toLowerCase().includes(q));
    renderYoutubeList(filtered);
}

function playYoutube(url, lastTime) {
    let videoId = '';
    try {
        const u = new URL(url);
        if (u.hostname.includes('youtu')) {
            if (u.searchParams.get('v')) videoId = u.searchParams.get('v');
            else if (u.pathname.startsWith('/embed/')) videoId = u.pathname.split('/embed/')[1];
            else if (u.pathname.length > 1) videoId = u.pathname.slice(1);
        }
    } catch {}
    if (!videoId) {
        $('#playerSection').html('<i>Không nhận diện được video ID!</i>');
        return;
    }
    lastUrl = url;
    lastVideoId = videoId;
    lastTime = lastTime || 0;
    // Sử dụng width:100% và aspect-ratio cho responsive
    $('#playerSection').html(`
        <div style="width:100%;max-width:100%;">
            <div style="position:relative;width:100%;padding-bottom:56.25%;">
                <iframe id="ytplayer"
                    style="position:absolute;top:0;left:0;width:100%;height:100%;"
                    src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&start=${Math.floor(lastTime)}"
                    frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
        </div>
    `);
    // Nếu player đã tồn tại, load video mới
    if (typeof YT !== "undefined" && YT.Player && ytPlayer) {
        ytPlayer.loadVideoById({videoId: videoId, startSeconds: Math.floor(lastTime)});
    } else {
        ytPlayer = new YT.Player('ytplayer', {
            width: '100%',
            height: '100%',
            videoId: videoId,
            playerVars: { 'autoplay': 1, 'start': Math.floor(lastTime) },
            events: {
                'onReady': function(event) {
                    event.target.playVideo();
                    if (ytPlayerInterval) clearInterval(ytPlayerInterval);
                    ytPlayerInterval = setInterval(saveYoutubeTime, 5000);
                }
            }
        });
    }
    // Đánh dấu đã xem
    $.ajax({
        url: '/youtube_links/update',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({url: url, watched: true}),
        success: function() {
            loadYoutubeLinks(); // cập nhật lại giao diện
        }
    });
}

// Lưu lại thời gian đang xem khi đóng trang
window.onbeforeunload = function() {
    saveYoutubeTime();
};

function saveYoutubeTime() {
    if (!ytPlayer || !lastUrl) return;
    let current = 0;
    try {
        current = ytPlayer.getCurrentTime ? Math.floor(ytPlayer.getCurrentTime()) : 0;
    } catch {}
    $.ajax({
        url: '/youtube_links/update',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({url: lastUrl, last_time: current}),
        success: function() {}
    });
}

function readVocab() {
    const text = document.getElementById('vocabInput').value.trim();
    if (!text) return;
    const utterance = new SpeechSynthesisUtterance(text);
    const voiceSelect = document.getElementById('voiceSelect');
    if (voices.length && voiceSelect && voiceSelect.value) {
        utterance.voice = voices[voiceSelect.value];
    }
    utterance.lang = utterance.voice ? utterance.voice.lang : 'en-US';
    window.speechSynthesis.speak(utterance);
}

let voices = [];
function populateVoiceList() {
    voices = window.speechSynthesis.getVoices();
    const voiceSelect = document.getElementById('voiceSelect');
    voiceSelect.innerHTML = '';
    voices.forEach((voice, i) => {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(option);
    });
}
// Gọi lại khi voices đã sẵn sàng
if (typeof speechSynthesis !== 'undefined') {
    speechSynthesis.onvoiceschanged = populateVoiceList;
    populateVoiceList();
}

$(function() {
    loadYoutubeLinks();
});
</script>
</body>
</html>